<h1><%= title %></h1>

<%- vehicleHtml %>

<%- messages() %>

<section class="favorites-section">
  <% if (locals.loggedin) { %>

    <div class="fav-actions">
      <% if (!favorite) { %>
        <form method="post" action="/favorites/add/<%= inv_id %>">
          <button type="submit" class="btn-primary">Add to Favorites</button>
        </form>
      <% } else { %>
        <form method="post" action="/favorites/remove/<%= inv_id %>">
          <button type="submit" class="btn-danger">Remove from Favorites</button>
        </form>
      <% } %>

      <a class="btn-secondary" href="/favorites">View My Favorites</a>
    </div>

  <% } else { %>
    <p><a href="/account/login">Log in</a> to save this vehicle to favorites.</p>
  <% } %>
</section>

<section class="reviews-section">
  <h2>Vehicle Reviews</h2>

  <%
    function renderStars(value) {
      const raw = Number(value) || 0
      const rating = Math.min(5, Math.max(0, Math.round(raw)))

      let html = '<span class="stars" aria-label="Rating ' + rating + ' out of 5">'
      for (let i = 1; i <= 5; i++) {
        html += (i <= rating)
          ? '<span class="star filled">★</span>'
          : '<span class="star empty">★</span>'
      }
      html += '</span>'
      return html
    }
  %>

  <% if (reviewSummary && Number(reviewSummary.count) > 0) { %>
    <div class="review-summary">
      <div><strong>Average Rating:</strong> <%= Number(reviewSummary.avg).toFixed(1) %> / 5</div>
      <div><%- renderStars(reviewSummary.avg) %></div>
      <div>(<%= reviewSummary.count %> review(s))</div>
    </div>
  <% } else { %>
    <p>No reviews yet. Be the first to leave one!</p>
  <% } %>

  <% if (reviews && reviews.length > 0) { %>
    <ul class="review-list">
      <% reviews.forEach(function(review) { %>
        <li class="review-item">
          <div class="review-meta">
            <strong><%= review.account_firstname %> <%= review.account_lastname %></strong>
            <span>—</span>
            <span><%- renderStars(review.rating) %></span>
            <span>(<%= review.rating %>/5)</span>
          </div>

          <% if (review.review_title) { %>
            <p class="review-title"><em><%= review.review_title %></em></p>
          <% } %>

          <p class="review-text"><%= review.review_text %></p>

          <div class="review-date">
            <%= new Date(review.created_at).toLocaleDateString() %>
          </div>
        </li>
      <% }) %>
    </ul>
  <% } %>
</section>

<section class="add-review-section">
  <h3>Leave a Review</h3>

  <% if (locals.loggedin) { %>
    <form method="post" action="/review/add/<%= inv_id %>">
      <div>
        <label for="rating">Rating (1–5)</label>
        <input type="number" id="rating" name="rating" min="1" max="5" required>
      </div>

      <div>
        <label for="review_title">Title (Optional)</label>
        <input type="text" id="review_title" name="review_title" maxlength="60">
      </div>

      <div>
        <label for="review_text">Your Review</label>
        <textarea id="review_text" name="review_text" minlength="10" required></textarea>
      </div>

      <button type="submit">Submit Review</button>
    </form>
  <% } else { %>
    <p><a href="/account/login">Log in</a> to leave a review.</p>
  <% } %>
</section>
